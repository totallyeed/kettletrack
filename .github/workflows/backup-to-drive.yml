name: Backup to Google Drive

on:
  push:
    branches:
      - main
    paths:
      - 'kettletrack-pwa.html'
      - 'service-worker.js'
      - 'manifest.json'
      - 'README.md'
      - 'CHANGELOG.md'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  backup:
    name: Backup to Google Drive
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate Backup Name
        id: backup-name
        run: |
          TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          BACKUP_NAME="KettleTrack_${TIMESTAMP}_${COMMIT_SHORT}"
          echo "name=$BACKUP_NAME" >> $GITHUB_OUTPUT
      
      - name: Create Backup Archive
        run: |
          zip -r backup.zip . -x "*.git*" -x "*node_modules*" -x "*.DS_Store"
      
      - name: Setup rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          echo '${{ secrets.GOOGLE_DRIVE_SA_JSON }}' > sa.json
          PWD=$(pwd)
          cat > ~/.config/rclone/rclone.conf << RCLONE_EOF
          [gdrive]
          type = drive
          scope = drive
          service_account_file = ${PWD}/sa.json
          RCLONE_EOF
          cat ~/.config/rclone/rclone.conf
          ls -la sa.json
      
      - name: Upload to Google Drive
        env:
          FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          BACKUP_NAME: ${{ steps.backup-name.outputs.name }}
        run: |
          rclone copy backup.zip gdrive:$FOLDER_ID --drive-use-trash=false --verbose
          rclone moveto "gdrive:$FOLDER_ID/backup.zip" "gdrive:$FOLDER_ID/${BACKUP_NAME}.zip" --drive-use-trash=false
      
      - name: Cleanup old backups
        env:
          FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          rclone ls gdrive:$FOLDER_ID --max-depth 1 | grep "KettleTrack_.*\.zip" | sort -r | tail -n +11 | while read size filename; do
            rclone delete "gdrive:$FOLDER_ID/$filename" --drive-use-trash=false
          done
      
      - name: Cleanup Secrets
        if: always()
        run: |
          rm -f sa.json
          rm -f backup.zip
          rm -rf ~/.config/rclone

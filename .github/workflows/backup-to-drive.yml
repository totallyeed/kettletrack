name: Backup to Google Drive

on:
  push:
    branches:
      - main
    paths:
      - 'kettletrack-pwa.html'
      - 'service-worker.js'
      - 'manifest.json'
      - 'README.md'
      - 'CHANGELOG.md'
  
  release:
    types: [published]
  
  workflow_dispatch:

jobs:
  backup:
    name: Backup to Google Drive
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“… Generate Backup Name
        id: backup-name
        run: |
          TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          BACKUP_NAME="KettleTrack_${TIMESTAMP}_${COMMIT_SHORT}"
          echo "name=$BACKUP_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Backup Name: $BACKUP_NAME"
      
      - name: ğŸ—œï¸ Create Backup Archive
        run: |
          zip -r backup.zip . \
            -x "*.git*" \
            -x "*node_modules*" \
            -x "*.DS_Store" \
            -x "*backup.zip"
          
          echo "ğŸ“Š Backup Size:"
          ls -lh backup.zip
      
      - name: ğŸ”§ Setup rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          
          mkdir -p ~/.config/rclone
          
          echo '${{ secrets.GOOGLE_DRIVE_SA_JSON }}' > sa.json
          
          cat > ~/.config/rclone/rclone.conf << EOF
          [gdrive]
          type = drive
          scope = drive
          service_account_file = $(pwd)/sa.json
          team_drive = 
          EOF
          
          echo "âœ… rclone configured"
      
      - name: ğŸš€ Upload to Google Drive
        env:
          FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          BACKUP_NAME: ${{ steps.backup-name.outputs.name }}
        run: |
          rclone copy backup.zip gdrive:$FOLDER_ID \
            --drive-use-trash=false \
            --stats 1s \
            --verbose
          
          rclone moveto \
            "gdrive:$FOLDER_ID/backup.zip" \
            "gdrive:$FOLDER_ID/${BACKUP_NAME}.zip" \
            --drive-use-trash=false
          
          echo "âœ… Backup uploaded: ${BACKUP_NAME}.zip"
      
      - name: ğŸ§¹ Cleanup old backups (keep last 10)
        env:
          FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          rclone ls gdrive:$FOLDER_ID --max-depth 1 | \
            grep "KettleTrack_.*\.zip" | \
            sort -r | \
            tail -n +11 | \
            while read size filename; do
              echo "ğŸ—‘ï¸  Deleting old backup: $filename"
              rclone delete "gdrive:$FOLDER_ID/$filename" --drive-use-trash=false
            done
          
          echo "âœ… Cleanup complete"
      
      - name: ğŸ”’ Cleanup Secrets
        if: always()
        run: |
          rm -f sa.json
          rm -f backup.zip
          rm -rf ~/.config/rclone
      
      - name: ğŸ“Š Backup Summary
        run: |
          echo "## ğŸ‰ Backup Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Backup Name:** \`${{ steps.backup-name.outputs.name }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Uploaded to Google Drive successfully" >> $GITHUB_STEP_SUMMARY
```

#### 4. Committen

Scrolle runter zum **"Commit changes"** Bereich:
```
Commit message: Add automated Google Drive backup workflow
Extended description: (leer lassen)
```

WÃ¤hle: **"Commit directly to the main branch"**

Klicke: **"Commit changes"**

---

## Das war's! ğŸ‰

Die Datei ist jetzt auf GitHub und der Workflow ist **sofort aktiv**.

---

## Wie es funktioniert
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DU erstellst .yaml Datei auf GitHub.com              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GitHub Actions liest die .yaml Datei                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bei jedem Push:                                      â”‚
â”‚ 1. GitHub lÃ¤dt dein Repository runter (in der Cloud) â”‚
â”‚ 2. Erstellt ZIP                                      â”‚
â”‚ 3. LÃ¤dt zu Google Drive hoch                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Wichtig:** Der Workflow lÃ¤uft **in der GitHub Cloud**, nicht auf deinem Mac!

GitHub:
- Checkt automatisch dein Repository aus
- Hat Zugriff auf alle Dateien
- Macht das Backup
- LÃ¤dt zu Drive hoch

Alles passiert auf **GitHub Servern**, du brauchst nichts lokal!

---

## Workflow testen

Nach dem Commit:

1. Gehe zu deinem Repository auf GitHub
2. Klicke auf **"Actions"** (oben in der Navigation)
3. Du solltest den Workflow sehen: **"Backup to Google Drive"**
4. Klicke drauf
5. Klicke **"Run workflow"** â†’ **"Run workflow"** (grÃ¼ner Button)
6. Warte 1-2 Minuten
7. PrÃ¼fe Google Drive â†’ KettleTrack â†’ GitHub-Backups

---

## Zu deiner Frage: Google Drive vs. lokal

**Du hast absolut recht!**

- âŒ Du brauchst **KEIN** lokales Git Repository
- âŒ Du brauchst **KEINE** Dateien auf deinem Mac
- âœ… Du brauchst **NUR** die `.yaml` Datei auf GitHub
- âœ… GitHub Actions macht den Rest in der Cloud

**Dein Workflow kann bleiben wie er ist:**
```
Du arbeitest in Google Drive
     â†“
LÃ¤dst zu GitHub hoch (wie bisher)
     â†“
GitHub Actions macht automatisch Backup
